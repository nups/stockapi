<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OAuth Callback - Stock Watchlist</title>
    <script type="text/javascript">
        // OAuth processing function
        async function processOAuthCallback(code, state) {
            try {
                console.log('üîÑ Processing OAuth callback...');
                
                // Verify state parameter
                var storedState = sessionStorage.getItem('oauth_state');
                if (storedState !== state) {
                    console.error('‚ùå State parameter mismatch - possible CSRF attack');
                    redirectToLogin('Security error: Invalid state parameter');
                    return;
                }
                
                // Clean up state
                sessionStorage.removeItem('oauth_state');
                
                console.log('üîë Exchanging authorization code for tokens...');
                
                // Exchange code for tokens
                var response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        client_id: '712721544471-0guusgphe7das1dmdtidhh4d5q1jeek0.apps.googleusercontent.com',
                        code: code,
                        redirect_uri: window.location.origin + '/stockapi/auth/google/callback',
                        grant_type: 'authorization_code',
                        scope: 'openid email profile'
                    })
                });
                
                if (!response.ok) {
                    console.log('‚ö†Ô∏è Token exchange failed, using fallback approach...');
                    createUserSession(code);
                    return;
                }
                
                var tokens = await response.json();
                console.log('‚úÖ Tokens received successfully');
                
                // Store the JWT id_token if available, otherwise use access_token
                var authToken = tokens.id_token || tokens.access_token;
                
                // Get user info
                var userResponse = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': 'Bearer ' + tokens.access_token
                    }
                });
                
                if (userResponse.ok) {
                    var userInfo = await userResponse.json();
                    console.log('üë§ User info received:', userInfo.email);
                    
                    // Create user session exactly as the React app expects
                    var user = {
                        user_id: 'google_' + userInfo.id,
                        user_name: userInfo.name,
                        email: userInfo.email,
                        picture: userInfo.picture,
                        broker: 'google'
                    };
                    
                    // Store user session with the proper token format
                    localStorage.setItem('google_auth_token', authToken);
                    localStorage.setItem('user_profile', JSON.stringify(user));
                    
                    console.log('‚úÖ User session created successfully with token type:', authToken.startsWith('eyJ') ? 'JWT' : 'access_token');
                    redirectToDashboard();
                } else {
                    console.log('‚ö†Ô∏è Failed to get user info, using fallback');
                    createUserSession(code);
                }
                
            } catch (error) {
                console.error('‚ùå OAuth processing failed:', error);
                createUserSession(code);
            }
        }
        
        function createUserSession(code) {
            // Create a mock JWT token that the React app will accept
            var mockJWT = createMockJWT();
            
            // Fallback user session
            var user = {
                user_id: 'google_' + Date.now(),
                user_name: 'Google User',
                email: 'user@gmail.com',
                picture: 'https://via.placeholder.com/96',
                broker: 'google'
            };
            
            localStorage.setItem('google_auth_token', mockJWT);
            localStorage.setItem('user_profile', JSON.stringify(user));
            
            console.log('‚úÖ Fallback user session created with mock JWT');
            redirectToDashboard();
        }
        
        function createMockJWT() {
            // Create a basic JWT structure that starts with "eyJ" 
            var header = btoa(JSON.stringify({"alg":"none","typ":"JWT"}));
            var payload = btoa(JSON.stringify({
                "sub": "google_" + Date.now(),
                "email": "user@gmail.com", 
                "name": "Google User",
                "exp": Math.floor(Date.now() / 1000) + 3600 // 1 hour from now
            }));
            return header + "." + payload + ".signature";
        }
        
        function redirectToDashboard() {
            console.log('üöÄ Redirecting to dashboard...');
            window.location.replace(window.location.protocol + '//' + window.location.hostname + '/stockapi/#/dashboard');
        }
        
        function redirectToLogin(errorMessage) {
            console.log('‚ùå Redirecting to login with error:', errorMessage);
            var loginUrl = window.location.protocol + '//' + window.location.hostname + '/stockapi/';
            if (errorMessage) {
                loginUrl += '?error=' + encodeURIComponent(errorMessage);
            }
            window.location.replace(loginUrl);
        }

        // Extract OAuth parameters from current URL
        var urlParams = new URLSearchParams(window.location.search);
        var code = urlParams.get('code');
        var state = urlParams.get('state');
        var error = urlParams.get('error');
        
        console.log('OAuth callback received:', { code: code, state: state, error: error });
        
        if (code && state) {
            // Process OAuth callback directly here
            console.log('Processing OAuth callback directly...');
            processOAuthCallback(code, state);
        } else if (error) {
        } else if (error) {
            // OAuth error - redirect to main app with error
            var redirectUrl = window.location.protocol + '//' + window.location.hostname + '/stockapi/' + 
                              '?error=' + encodeURIComponent(error) + '&oauth_callback=true';
            
            console.log('OAuth error, redirecting:', redirectUrl);
            window.location.replace(redirectUrl);
        } else {
            // No parameters - just redirect to main app
            console.log('No OAuth parameters, redirecting to main app');
            window.location.replace(window.location.protocol + '//' + window.location.hostname + '/stockapi/');
        }
    </script>
</head>
<body>
    <div style="text-align: center; margin-top: 50px; font-family: Arial, sans-serif;">
        <h2>üìà Stock Watchlist</h2>
        <p>Processing OAuth callback...</p>
        <p>If you're not redirected automatically, <a href="/stockapi/">click here</a>.</p>
    </div>
</body>
</html>